From cd86780e04bfe4154eef86f8a3835936c3ab0eb2 Mon Sep 17 00:00:00 2001
From: darix <darix@users.noreply.github.com>
Date: Tue, 12 May 2020 13:58:15 +0200
Subject: [PATCH] Option to en-/disable force refresh in zypper (#215)

The default will still be force refresh to keep existing setups working.

1. Pillar option to turn off force refresh

```
zypper:
  refreshdb_force: false
```

2. Cmdline option to force refresh.

```
salt '*' pkg.refresh_db [force=true|false]
```

The cmdline option will override the pillar as well.

Co-authored-by: Alexander Graul <agraul@suse.com>
---
 salt/modules/zypperpkg.py | 32 +++++++++++++++++++++++---------
 1 file changed, 23 insertions(+), 9 deletions(-)

diff --git a/salt/modules/zypperpkg.py b/salt/modules/zypperpkg.py
index 8c1e05c21c..0a8635ca0b 100644
--- a/salt/modules/zypperpkg.py
+++ b/salt/modules/zypperpkg.py
@@ -1277,25 +1277,39 @@ def mod_repo(repo, **kwargs):
     return repo
 
 
-def refresh_db(root=None):
-    '''
-    Force a repository refresh by calling ``zypper refresh --force``, return a dict::
+def refresh_db(root=None, force=None):
+    """
+    Trigger a repository refresh by calling ``zypper refresh``. Refresh will run
+    with ``--force`` if the "force=True" flag is passed on the CLI or
+    ``refreshdb_force`` is set to ``true`` in the pillar. The CLI option
+    overrides the pillar setting.
 
-        {'<database name>': Bool}
+    It will return a dict::
 
-    root
-        operate on a different root directory.
+        {'<database name>': Bool}
 
     CLI Example:
 
     .. code-block:: bash
 
-        salt '*' pkg.refresh_db
-    '''
+        salt '*' pkg.refresh_db [force=true|false]
+
+    Pillar Example:
+
+    .. code-block:: yaml
+
+       zypper:
+         refreshdb_force: false
+    """
     # Remove rtag file to keep multiple refreshes from happening in pkg states
     salt.utils.pkg.clear_rtag(__opts__)
     ret = {}
-    out = __zypper__(root=root).refreshable.call('refresh', '--force')
+    refresh_opts = ['refresh']
+    if force is None:
+        force = __pillar__.get('zypper', {}).get('refreshdb_force', True)
+    if force:
+        refresh_opts.append('--force')
+    out = __zypper__(root=root).refreshable.call(*refresh_opts)
 
     for line in out.splitlines():
         if not line:
-- 
2.26.2


